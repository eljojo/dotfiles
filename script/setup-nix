#!/usr/bin/env bash
set -e

echo "=== Lix + nix-darwin Setup ==="
echo ""
echo "This script will install:"
echo "  1. Lix (modern Nix implementation)"
echo "  2. nix-darwin (macOS system management)"
echo "  3. home-manager channel"
echo ""
echo "Prerequisites:"
echo "  - macOS with admin access"
echo "  - Xcode Command Line Tools (xcode-select --install)"
echo ""
read -p "Press Enter to continue or Ctrl+C to abort..."

# Step 1: Install Lix
# https://lix.systems/install/
if ! command -v nix &> /dev/null; then
  echo ""
  echo "=== Installing Lix ==="
  curl -sSf -L https://install.lix.systems/lix | sh -s -- install
  echo ""
  echo "Please restart your shell or run: . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
  echo "Then re-run this script."
  exit 0
else
  echo "Nix/Lix already installed: $(nix --version)"
fi

# Step 2: Set up channels
echo ""
echo "=== Setting up channels ==="
sudo nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
sudo nix-channel --add https://github.com/nix-darwin/nix-darwin/archive/master.tar.gz darwin
sudo nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
sudo nix-channel --update

# Step 3: Install nix-darwin
# https://github.com/nix-darwin/nix-darwin
echo ""
echo "=== Installing nix-darwin ==="
nix-build '<darwin>' -A installer
./result/bin/darwin-installer
rm -rf ./result

# Step 4: Remove default config (we use our own)
rm -f ~/.nixpkgs/darwin-configuration.nix

# Step 5: Build with our config
echo ""
echo "=== Building with dotfiles config ==="
./nix-maint

echo ""
echo "=== Done! ==="
echo "nix-darwin is now managing your system."
echo "Run 'darwin-rebuild switch' to apply future changes."
