#!/usr/bin/env bash
#
# bootstrap - complete setup for a new Mac
#
# This script is idempotent - safe to run multiple times.

cd "$(dirname "$0")/.."
DOTFILES_ROOT=$(pwd)

set -e

# Colors
info()    { printf "\n  [ \033[00;34m..\033[0m ] %s\n" "$1"; }
success() { printf "  [ \033[00;32mOK\033[0m ] %s\n" "$1"; }
warn()    { printf "  [ \033[0;33m!!\033[0m ] %s\n" "$1"; }
fail()    { printf "  [ \033[0;31mFAIL\033[0m ] %s\n" "$1"; exit 1; }
ask()     { printf "\n  [ \033[0;33m?\033[0m ] %s " "$1"; }

echo ""
echo "  ╔══════════════════════════════════════╗"
echo "  ║       jojo's dotfiles bootstrap      ║"
echo "  ╚══════════════════════════════════════╝"
echo ""

# ============================================
# Git remote
# ============================================
info "Setting git remote to SSH..."
git remote set-url origin git@github.com:eljojo/dotfiles.git 2>/dev/null || true
success "Git remote configured"

# ============================================
# Secrets file
# ============================================
if [ ! -f ~/.env-vars ]; then
  touch ~/.env-vars
  success "Created ~/.env-vars"
else
  success "~/.env-vars already exists"
fi

# ============================================
# Homebrew
# ============================================
info "Checking Homebrew..."
if ! command -v brew &> /dev/null; then
  echo "  Installing Homebrew..."
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  # Load homebrew into current shell
  if [ -d /opt/homebrew/bin ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
  fi
  success "Homebrew installed"
else
  success "Homebrew already installed"
fi

# Disable analytics
brew analytics off 2>/dev/null || true

# ============================================
# Lix / Nix
# ============================================
info "Checking Nix..."
if ! command -v nix &> /dev/null; then
  echo "  Installing Lix (modern Nix implementation)..."
  echo "  See: https://lix.systems/install/"
  curl -sSf -L https://install.lix.systems/lix | sh -s -- install

  echo ""
  warn "Nix installed! Please restart your shell and re-run this script."
  echo "  Or run: . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
  exit 0
else
  success "Nix already installed: $(nix --version 2>/dev/null | head -1)"
fi

# ============================================
# nix-darwin
# ============================================
info "Checking nix-darwin..."
if ! command -v darwin-rebuild &> /dev/null; then
  echo "  Setting up nix-darwin channels..."
  sudo nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
  sudo nix-channel --add https://github.com/nix-darwin/nix-darwin/archive/master.tar.gz darwin
  sudo nix-channel --add https://github.com/nix-community/home-manager/archive/master.tar.gz home-manager
  sudo nix-channel --update

  echo "  Installing nix-darwin..."
  nix-build '<darwin>' -A installer
  ./result/bin/darwin-installer
  rm -rf ./result

  # Remove default config (we use our own)
  rm -f ~/.nixpkgs/darwin-configuration.nix
  success "nix-darwin installed"
else
  success "nix-darwin already installed"
fi

# ============================================
# Apply nix configuration
# ============================================
info "Applying nix-darwin configuration..."
echo "  Updating channels..."
sudo nix-channel --update

echo "  Building system configuration..."
sudo darwin-rebuild switch \
  -I darwin-config=$HOME/.dotfiles/nix/darwin-configuration.nix
success "nix-darwin configuration applied"

# ============================================
# Vim
# ============================================
info "Setting up Vim..."
if [ -d "$HOME/.vim" ]; then
  cd "$HOME/.vim"
  git remote set-url origin git@github.com:eljojo/vimfiles.git 2>/dev/null || true
  echo "  Updating vim plugins..."
  vim +PlugUpdate +qall 2>/dev/null || vim +PlugInstall +qall 2>/dev/null || true
  cd "$DOTFILES_ROOT"
  success "Vim plugins updated"
else
  echo "  Cloning vimfiles..."
  git clone https://github.com/eljojo/vimfiles.git ~/.vim
  ~/.vim/install.sh
  success "Vim installed"
fi

# ============================================
# SSH key
# ============================================
info "Checking SSH key..."
if [ ! -f "$HOME/.ssh/id_ed25519" ]; then
  echo "  Generating new SSH key..."
  mkdir -p ~/.ssh
  ssh-keygen -t ed25519 -a 100 -C "$(whoami)@$(hostname -s)"

  cat > ~/.ssh/config << 'EOF'
Host *
  AddKeysToAgent yes
  UseKeychain yes
  IdentityFile ~/.ssh/id_ed25519
EOF

  if [ "$(uname -s)" == "Darwin" ]; then
    ssh-add --apple-use-keychain ~/.ssh/id_ed25519
  else
    ssh-add ~/.ssh/id_ed25519
  fi

  echo ""
  echo "  Your new public key:"
  echo ""
  cat ~/.ssh/id_ed25519.pub
  echo ""
  success "SSH key generated"
else
  success "SSH key already exists"
fi

# ============================================
# macOS defaults
# ============================================
ask "Configure macOS defaults? (Safari, Finder, etc.) [y/N]"
read -n 1 -r
echo ""
if [[ $REPLY =~ ^[Yy]$ ]]; then
  info "Applying macOS defaults..."
  "$DOTFILES_ROOT/osx/set-defaults.sh"
  success "macOS defaults applied"
else
  success "Skipped macOS defaults"
fi

# ============================================
# Manual app installs (Firefox, Spotify, Roon)
# ============================================
install_dmg_app() {
  local name=$1
  local url=$2
  local volume=$3

  if [ -d "/Applications/$name.app" ]; then
    success "$name already installed"
    return 0
  fi

  echo "  Installing $name..."
  curl -Lo "/tmp/$name.dmg" "$url"
  hdiutil attach "/tmp/$name.dmg" -quiet
  ditto -rsrc "/Volumes/$volume/$name.app" "/Applications/$name.app"
  hdiutil detach "/Volumes/$volume" -quiet
  rm "/tmp/$name.dmg"
  success "$name installed"
}

install_zip_app() {
  local name=$1
  local url=$2

  if [ -d "/Applications/$name.app" ]; then
    success "$name already installed"
    return 0
  fi

  echo "  Installing $name..."
  curl -Lo "/tmp/$name.zip" "$url"
  unzip -q "/tmp/$name.zip" -d /Applications/
  rm "/tmp/$name.zip"
  success "$name installed"
}

info "Checking manual apps..."

install_dmg_app "Firefox" \
  "https://download.mozilla.org/?product=firefox-latest&os=osx&lang=en-US" \
  "Firefox"

install_dmg_app "Spotify" \
  "https://download.scdn.co/Spotify.dmg" \
  "Spotify"

install_dmg_app "Roon" \
  "http://download.roonlabs.com/builds/Roon.dmg" \
  "Roon"

install_dmg_app "MQTTX" \
  "https://www.emqx.com/en/downloads/MQTTX/v1.13.0/MQTTX-1.13.0-arm64.dmg" \
  "MQTTX 1.13.0-arm64"

install_zip_app "1Password" \
  "https://downloads.1password.com/mac/1Password.zip"

# ============================================
# Done!
# ============================================
echo ""
echo "  ╔══════════════════════════════════════╗"
echo "  ║         Bootstrap complete!          ║"
echo "  ╚══════════════════════════════════════╝"
echo ""
echo "  Your system is ready. Open a new terminal to use the new shell."
echo ""
